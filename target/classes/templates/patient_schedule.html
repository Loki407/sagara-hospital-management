<!DOCTYPE html>
<html>
<head>
    <title>My Schedule - Sagara Hospital</title>
    <style>
        body { font-family: Arial; margin: 0; background: #f5f5f5; min-height: 100vh; }
        body.dark { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .navbar { background: #333; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        body.dark .navbar { background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); }
        .navbar a { color: white; text-decoration: none; margin-left: 1rem; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }
        .card { background: white; padding: 2rem; margin: 2rem 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        body.dark .card { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
        .schedule-item { background: #f8f9fa; padding: 1.5rem; margin: 1rem 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .schedule-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .schedule-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .btn { padding: 0.8rem 1.5rem; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 0.2rem; }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-danger { background: #dc3545; }
        .status-scheduled { color: #007bff; font-weight: bold; }
        .status-completed { color: #28a745; font-weight: bold; }
        .status-cancelled { color: #dc3545; font-weight: bold; }
        .upcoming { border-left-color: #28a745; }
        .past { border-left-color: #6c757d; opacity: 0.8; }
        .today { border-left-color: #ffc107; background: #fff3cd; }
    </style>
</head>
<body>
    <div class="navbar">
        <h2>‚öïÔ∏è Sagara Hospital - My Schedule</h2>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div id="navProfile" style="display: flex; align-items: center; gap: 0.5rem; margin-right: 1rem;">
                <img id="navProfilePic" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover;" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzUiIGhlaWdodD0iMzUiIHZpZXdCb3g9IjAgMCAzNSAzNSiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzNSIgaGVpZ2h0PSIzNSIgZmlsbD0iIzAwN2JmZiIvPgo8dGV4dCB4PSIxNy41IiB5PSIyMiIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UDwvdGV4dD4KPC9zdmc+" alt="Profile">
                <span id="navProfileName" style="color: white; font-size: 0.9rem;">Patient</span>
            </div>
            <a href="/patient_dashboard">Dashboard</a>
            <a href="/patient_doctors">Find Doctors</a>
            <a href="/book_appointment">Book Appointment</a>
            <a href="/patient_records">My Records</a>
            <a href="/patient_profile">Profile</a>
            <a href="/patient_schedule">My Schedule</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>My Appointment Schedule</h2>
            <p>View and manage your upcoming and past appointments</p>
            
            <div style="margin-bottom: 2rem;">
                <button class="btn btn-success" onclick="window.location.href='/book_appointment'">+ Book New Appointment</button>
            </div>
            
            <div id="scheduleList">
                <p>Loading your schedule...</p>
            </div>
        </div>
    </div>

    <script src="/js/theme.js"></script>
    <script>
        let currentPatient = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadPatientProfile();
            loadPatientSchedule();
        });

        function loadPatientProfile() {
            currentPatient = JSON.parse(localStorage.getItem('currentPatient') || '{}');
            
            if (!currentPatient.email) {
                alert('Please log in to view your schedule');
                window.location.href = '/login';
                return;
            }

            document.getElementById('navProfileName').textContent = `${currentPatient.firstName} ${currentPatient.lastName}`;
            
            const savedPicture = localStorage.getItem('profilePicture');
            if (savedPicture) {
                document.getElementById('navProfilePic').src = savedPicture;
            }
        }

        async function loadPatientSchedule() {
            if (!currentPatient || !currentPatient.email) {
                document.getElementById('scheduleList').innerHTML = '<p>Please log in to view your schedule.</p>';
                return;
            }

            try {
                const response = await fetch(`/api/patient-schedule/${currentPatient.email}`);
                const schedules = await response.json();
                displaySchedule(schedules);
            } catch (error) {
                console.error('Error loading schedule:', error);
                document.getElementById('scheduleList').innerHTML = '<p>Error loading schedule.</p>';
            }
        }

        function displaySchedule(schedules) {
            const container = document.getElementById('scheduleList');
            
            if (schedules.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìÖ</div>
                        <h3>No appointments scheduled</h3>
                        <p>Book your first appointment to get started</p>
                        <button class="btn btn-success" onclick="window.location.href='/book_appointment'">Book Appointment</button>
                    </div>
                `;
                return;
            }

            const now = new Date();
            const today = now.toDateString();

            container.innerHTML = schedules.map(schedule => {
                const appointmentDate = new Date(schedule.appointmentDateTime);
                const isToday = appointmentDate.toDateString() === today;
                const isPast = appointmentDate < now;
                const isUpcoming = appointmentDate > now;

                let cssClass = 'schedule-item';
                if (isToday) cssClass += ' today';
                else if (isPast) cssClass += ' past';
                else if (isUpcoming) cssClass += ' upcoming';

                return `
                    <div class="${cssClass}">
                        <div class="schedule-header">
                            <h4>${schedule.doctorName} - ${schedule.appointmentType}</h4>
                            <span class="status-${schedule.status.toLowerCase()}">${schedule.status}</span>
                        </div>
                        <div class="schedule-details">
                            <div>
                                <strong>Date:</strong> ${formatDate(schedule.appointmentDateTime)}
                            </div>
                            <div>
                                <strong>Time:</strong> ${formatTime(schedule.appointmentDateTime)}
                            </div>
                            <div>
                                <strong>Location:</strong> ${schedule.location || 'TBD'}
                            </div>
                            <div>
                                <strong>Type:</strong> ${schedule.appointmentType}
                            </div>
                        </div>
                        ${schedule.notes ? `<div style="margin-top: 1rem;"><strong>Notes:</strong> ${schedule.notes}</div>` : ''}
                        <div style="margin-top: 1rem; text-align: right;">
                            ${isUpcoming ? `
                                <button class="btn btn-warning" onclick="rescheduleAppointment(${schedule.id})">Reschedule</button>
                                <button class="btn btn-danger" onclick="cancelAppointment(${schedule.id})">Cancel</button>
                            ` : ''}
                            ${isPast && schedule.status === 'Completed' ? `
                                <button class="btn" onclick="viewDetails(${schedule.id})">View Details</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatDate(dateTimeString) {
            return new Date(dateTimeString).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatTime(dateTimeString) {
            return new Date(dateTimeString).toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        async function rescheduleAppointment(id) {
            const newDate = prompt('Enter new date (YYYY-MM-DD):');
            const newTime = prompt('Enter new time (HH:MM):');
            
            if (newDate && newTime) {
                try {
                    const newDateTime = `${newDate}T${newTime}:00`;
                    const response = await fetch(`/api/patient-schedule/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            appointmentDateTime: newDateTime,
                            status: 'Rescheduled'
                        })
                    });

                    if (response.ok) {
                        alert('Appointment rescheduled successfully!');
                        loadPatientSchedule();
                    } else {
                        alert('Error rescheduling appointment');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error rescheduling appointment');
                }
            }
        }

        async function cancelAppointment(id) {
            if (confirm('Are you sure you want to cancel this appointment?')) {
                try {
                    const response = await fetch(`/api/patient-schedule/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'Cancelled' })
                    });

                    if (response.ok) {
                        alert('Appointment cancelled successfully!');
                        loadPatientSchedule();
                    } else {
                        alert('Error cancelling appointment');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error cancelling appointment');
                }
            }
        }

        function viewDetails(id) {
            alert('Appointment details and medical records would be displayed here.');
        }

        function logout() {
            localStorage.removeItem('currentPatient');
            localStorage.removeItem('currentPatientEmail');
            localStorage.removeItem('profilePicture');
            window.location.href = '/login';
        }
    </script>
</body>
</html>