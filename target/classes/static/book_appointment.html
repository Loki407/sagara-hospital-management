<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - Hospital Management</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">üè• Hospital</div>
            <ul class="nav-links">
                <li><a href="/doctors.html">Back to Doctors</a></li>
                <li><a href="#" onclick="logout()">Logout</a></li>
            </ul>
        </div>
    </nav>

    <div class="dashboard">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Book Your Appointment</h1>
            <p class="dashboard-subtitle">Schedule a consultation with our expert doctors</p>
        </div>

        <!-- Selected Doctor Info -->
        <div class="card" id="selectedDoctorCard" style="display: none;">
            <div class="card-header">
                <h2 class="card-title">Selected Doctor</h2>
            </div>
            <div id="selectedDoctorInfo"></div>
        </div>

        <!-- Appointment Booking Form -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Appointment Details</h2>
                <p class="card-subtitle">Please fill in your information</p>
            </div>

            <form id="appointmentForm">
                <!-- Patient Information Section -->
                <div class="form-section">
                    <h3 class="form-section-title">Patient Information</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patientName" class="form-label">Full Name</label>
                            <input type="text" id="patientName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="patientEmail" class="form-label">Email Address</label>
                            <input type="email" id="patientEmail" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patientPhone" class="form-label">Phone Number</label>
                            <input type="tel" id="patientPhone" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="patientAge" class="form-label">Age</label>
                            <input type="number" id="patientAge" class="form-input" min="1" max="120">
                        </div>
                    </div>
                </div>

                <!-- Appointment Details Section -->
                <div class="form-section">
                    <h3 class="form-section-title">Appointment Schedule</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="doctorSelect" class="form-label">Select Doctor</label>
                            <select id="doctorSelect" class="form-select" required>
                                <option value="">Choose a doctor...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="appointmentDate" class="form-label">Preferred Date</label>
                            <input type="date" id="appointmentDate" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="appointmentTime" class="form-label">Preferred Time</label>
                            <select id="appointmentTime" class="form-select" required>
                                <option value="">Select time...</option>
                                <option value="09:00">9:00 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="16:00">4:00 PM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="appointmentType" class="form-label">Appointment Type</label>
                            <select id="appointmentType" class="form-select">
                                <option value="consultation">Consultation</option>
                                <option value="follow-up">Follow-up</option>
                                <option value="emergency">Emergency</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="form-section">
                    <h3 class="form-section-title">Additional Information</h3>
                    
                    <div class="form-group">
                        <label for="symptoms" class="form-label">Symptoms or Reason for Visit</label>
                        <textarea id="symptoms" class="form-input" rows="4" 
                                placeholder="Please describe your symptoms or reason for the appointment..."></textarea>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="window.history.back()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Book Appointment</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        // Load doctors and handle pre-selection
        loadDoctors();
        
        // Set minimum date to today
        document.getElementById('appointmentDate').min = new Date().toISOString().split('T')[0];

        async function loadDoctors() {
            try {
                const doctors = await DoctorAPI.getAll();
                const select = document.getElementById('doctorSelect');
                
                doctors.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.id;
                    option.textContent = `Dr. ${doctor.firstName} ${doctor.lastName} - ${doctor.specialty}`;
                    select.appendChild(option);
                });

                // Check if a doctor was pre-selected
                const selectedDoctorId = localStorage.getItem('selectedDoctorId');
                if (selectedDoctorId) {
                    select.value = selectedDoctorId;
                    showSelectedDoctor(doctors.find(d => d.id == selectedDoctorId));
                    localStorage.removeItem('selectedDoctorId');
                }
            } catch (error) {
                Utils.showMessage('Failed to load doctors', 'error');
            }
        }

        function showSelectedDoctor(doctor) {
            if (doctor) {
                document.getElementById('selectedDoctorCard').style.display = 'block';
                document.getElementById('selectedDoctorInfo').innerHTML = `
                    <div class="doctor-card">
                        <div class="doctor-image">
                            ${doctor.firstName.charAt(0)}${doctor.lastName.charAt(0)}
                        </div>
                        <div class="doctor-info">
                            <h3 class="doctor-name">Dr. ${doctor.firstName} ${doctor.lastName}</h3>
                            <p class="doctor-specialty">${doctor.specialty}</p>
                            <p class="doctor-email">${doctor.email}</p>
                        </div>
                    </div>
                `;
            }
        }

        // Handle doctor selection change
        document.getElementById('doctorSelect').addEventListener('change', async function() {
            const doctorId = this.value;
            if (doctorId) {
                try {
                    const doctors = await DoctorAPI.getAll();
                    const doctor = doctors.find(d => d.id == doctorId);
                    showSelectedDoctor(doctor);
                } catch (error) {
                    console.error('Failed to load doctor details');
                }
            } else {
                document.getElementById('selectedDoctorCard').style.display = 'none';
            }
        });

        // Handle form submission
        document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const appointmentData = {
                patientName: document.getElementById('patientName').value,
                patientEmail: document.getElementById('patientEmail').value,
                patientPhone: document.getElementById('patientPhone').value,
                doctorId: parseInt(document.getElementById('doctorSelect').value),
                appointmentDate: document.getElementById('appointmentDate').value,
                appointmentTime: document.getElementById('appointmentTime').value
            };
            
            try {
                await AppointmentAPI.create(appointmentData);
                Utils.showMessage('Appointment booked successfully! We will contact you soon.', 'success');
                
                // Reset form after successful booking
                setTimeout(() => {
                    document.getElementById('appointmentForm').reset();
                    document.getElementById('selectedDoctorCard').style.display = 'none';
                }, 2000);
                
            } catch (error) {
                Utils.showMessage('Failed to book appointment. Please try again.', 'error');
            }
        });

        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>