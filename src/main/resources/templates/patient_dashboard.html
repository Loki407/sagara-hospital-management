<!DOCTYPE html>
<html>
<head>
    <title>Patient Dashboard</title>
    <style>
        body { font-family: Arial; margin: 0; background: #f5f5f5; }
        .navbar { background: #333; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .navbar a { color: white; text-decoration: none; margin-left: 1rem; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }
        .card { background: white; padding: 2rem; margin: 2rem 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 3rem; }
        .action-card { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; cursor: pointer; transition: transform 0.3s; }
        .action-card:hover { transform: translateY(-5px); }
        .action-icon { font-size: 3rem; margin-bottom: 1rem; }
        .appointment-card { background: #f8f9fa; padding: 1.5rem; margin: 1rem 0; border-radius: 8px; border-left: 4px solid #007bff; }
        .appointment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; }
        .status-confirmed { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        h1, h2 { color: #333; }
        .welcome-title { text-align: center; color: #007bff; margin-bottom: 0.5rem; }
        .welcome-subtitle { text-align: center; color: #666; margin-bottom: 3rem; }
        
        /* Calendar Styles */
        .calendar-container { background: white; border-radius: 10px; padding: 1.5rem; margin: 1rem 0; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .calendar-nav { background: #007bff; color: white; border: none; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #ddd; }
        .calendar-day { background: white; padding: 0.8rem; text-align: center; min-height: 60px; position: relative; }
        .calendar-day.other-month { color: #ccc; background: #f8f9fa; }
        .calendar-day.has-appointment { background: #e3f2fd; border-left: 3px solid #007bff; }
        .appointment-dot { width: 8px; height: 8px; background: #007bff; border-radius: 50%; position: absolute; top: 5px; right: 5px; }
        
        /* Profile Picture Styles */
        .profile-picture-container { position: relative; display: inline-block; }
        .profile-picture { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; cursor: pointer; }
        .profile-upload-btn { position: absolute; bottom: 0; right: 0; background: #007bff; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; }
        .profile-upload-input { display: none; }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container { padding: 0 1rem; }
            .quick-actions { grid-template-columns: 1fr; }
            .navbar { flex-direction: column; gap: 1rem; }
            .navbar div { display: flex; flex-wrap: wrap; gap: 0.5rem; }
            .calendar-grid { grid-template-columns: repeat(7, 1fr); font-size: 0.8rem; }
            .calendar-day { padding: 0.4rem; min-height: 40px; }
            .action-card { padding: 1rem; }
            .action-icon { font-size: 2rem; }
        }
        
        @media (max-width: 480px) {
            .navbar h2 { font-size: 1.2rem; }
            .navbar a { font-size: 0.9rem; }
            .welcome-title { font-size: 1.5rem; }
            .card { padding: 1rem; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h2>‚öïÔ∏è Patient Portal</h2>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div id="navProfile" style="display: flex; align-items: center; gap: 0.5rem; margin-right: 1rem;">
                <img id="navProfilePic" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover;" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzUiIGhlaWdodD0iMzUiIHZpZXdCb3g9IjAgMCAzNSAzNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjM1IiBoZWlnaHQ9IjM1IiBmaWxsPSIjMDA3YmZmIi8+Cjx0ZXh0IHg9IjE3LjUiIHk9IjIyIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5QPC90ZXh0Pgo8L3N2Zz4=" alt="Profile">
                <span id="navProfileName" style="color: white; font-size: 0.9rem;">Patient</span>
            </div>
            <a href="/patient_dashboard">Dashboard</a>
            <a href="/patient_home">Home</a>
            <a href="/patient_doctors">Find Doctors</a>
            <a href="/book_appointment">Book Appointment</a>
            <a href="/patient_records">My Records</a>
            <a href="/patient_profile">Profile</a>
            <a href="/patient_schedule">My Schedule</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </div>

    <div class="container">
        <div style="text-align: center; margin-bottom: 2rem;">
            <div class="profile-picture-container">
                <img id="profilePicture" class="profile-picture" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjMDA3YmZmIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjMwIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UDwvdGV4dD4KPC9zdmc+" alt="Profile Picture" onclick="document.getElementById('profileUpload').click()">
                <button class="profile-upload-btn" onclick="document.getElementById('profileUpload').click()">üì∑</button>
                <input type="file" id="profileUpload" class="profile-upload-input" accept="image/*">
            </div>
            <h1 class="welcome-title">Welcome to Sagara Hospital!</h1>
            <p class="welcome-subtitle">Alappuzha ‚Ä¢ Manage your appointments and health records</p>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="action-card" onclick="window.location.href='/book_appointment'">
                <div class="action-icon">üìÖ</div>
                <h3>Book Appointment</h3>
                <p>Schedule a new appointment</p>
            </div>
            
            <div class="action-card" onclick="window.location.href='/patient_doctors'">
                <div class="action-icon">üë®‚öïÔ∏è</div>
                <h3>Find Doctors</h3>
                <p>Browse our medical team</p>
            </div>
            
            <div class="action-card" onclick="window.location.href='/patient_records'">
                <div class="action-icon">üìã</div>
                <h3>Medical Records</h3>
                <p>View your health history</p>
            </div>
            
            <div class="action-card" onclick="window.location.href='/patient_schedule'">
                <div class="action-icon">üìÖ</div>
                <h3>My Schedule</h3>
                <p>View upcoming appointments</p>
            </div>
        </div>

        <!-- Appointment Calendar -->
        <div class="card">
            <h2>Your Appointments Calendar</h2>
            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="changeMonth(-1)">‚Üê</button>
                    <h3 id="currentMonth">Loading...</h3>
                    <button class="calendar-nav" onclick="changeMonth(1)">‚Üí</button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <div style="background: #f0f0f0; font-weight: bold; padding: 0.5rem;">Sun</div>
                    <div style="background: #f0f0f0; font-weight: bold; padding: 0.5rem;">Mon</div>
                    <div style="background: #f0f0f0; font-weight: bold; padding: 0.5rem;">Tue</div>
                    <div style="background: #f0f0f0; font-weight: bold; padding: 0.5rem;">Wed</div>
                    <div style="background: #f0f0f0; font-weight: bold; padding: 0.5rem;">Thu</div>
                    <div style="background: #f0f0f0; font-weight: bold; padding: 0.5rem;">Fri</div>
                    <div style="background: #f0f0f0; font-weight: bold; padding: 0.5rem;">Sat</div>
                </div>
            </div>
            
            <!-- Appointment List Toggle -->
            <div style="margin-top: 1rem; text-align: center;">
                <button class="btn" onclick="toggleView()" id="viewToggle">Show List View</button>
            </div>
            <div id="appointmentsList" style="display: none;">Loading your appointments...</div>
        </div>
        
        <!-- Appointment History -->
        <div class="card">
            <h2>Appointment History</h2>
            <div style="margin-bottom: 1rem;">
                <select id="statusFilter" onchange="filterHistory()" style="padding: 0.5rem; border-radius: 5px;">
                    <option value="all">All Appointments</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                    <option value="Confirmed">Upcoming</option>
                </select>
            </div>
            <div id="appointmentHistory">Loading history...</div>
        </div>
        
        <!-- Medical Records & Prescriptions -->
        <div class="card">
            <h2>Medical Records & Prescriptions</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div>
                    <h3>Recent Medical Records</h3>
                    <div id="recentRecordsList">Loading recent records...</div>
                </div>
                <div>
                    <h3>Quick Stats</h3>
                    <div id="recordStats">
                        <div style="background: #d1ecf1; padding: 1rem; border-radius: 5px; margin: 0.5rem 0;">
                            <strong>Total Records</strong><br>
                            <small id="totalRecords">0</small>
                        </div>
                        <div style="background: #e8f5e8; padding: 1rem; border-radius: 5px; margin: 0.5rem 0;">
                            <strong>Last Visit</strong><br>
                            <small id="lastVisit">No visits yet</small>
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn" onclick="window.location.href='/patient_records'">View All Records</button>
        </div>

        <!-- Health Summary -->
        <div class="card">
            <h2>Health Summary</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem;">
                <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 2rem; color: #28a745; margin-bottom: 0.5rem;">üíö</div>
                    <h4>Overall Health</h4>
                    <p style="color: #28a745; font-weight: 500;">Good</p>
                </div>
                
                <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 2rem; color: #007bff; margin-bottom: 0.5rem;">üìä</div>
                    <h4>Total Appointments</h4>
                    <p style="color: #007bff; font-weight: 500;" id="totalAppointments">0</p>
                </div>
                
                <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 2rem; color: #ffc107; margin-bottom: 0.5rem;">‚è∞</div>
                    <h4>Next Appointment</h4>
                    <p style="color: #ffc107; font-weight: 500;" id="nextAppointment">None scheduled</p>
                </div>
                
                <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 2rem; color: #dc3545; margin-bottom: 0.5rem;">üîî</div>
                    <h4>Notifications</h4>
                    <p style="color: #dc3545; font-weight: 500;" id="notificationCount">3 new</p>
                </div>
                
                <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <div style="font-size: 2rem; color: #6f42c1; margin-bottom: 0.5rem;">üìä</div>
                    <h4>Health Score</h4>
                    <p style="color: #6f42c1; font-weight: 500;">85/100</p>
                </div>
            </div>
        </div>
        
        <!-- Notifications Panel -->
        <div class="card">
            <h2>Notifications & Reminders</h2>
            <div id="notificationsList">
                <div style="background: #d4edda; border-left: 4px solid #28a745; padding: 1rem; margin: 0.5rem 0; border-radius: 5px;">
                    <strong>üìÖ Appointment Reminder</strong><br>
                    <small>Your appointment with Dr. Smith is tomorrow at 2:00 PM</small>
                </div>
                <div style="background: #cce5ff; border-left: 4px solid #007bff; padding: 1rem; margin: 0.5rem 0; border-radius: 5px;">
                    <strong>üìä Test Results Ready</strong><br>
                    <small>Your blood test results are now available</small>
                </div>
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 1rem; margin: 0.5rem 0; border-radius: 5px;">
                    <strong>üíä Prescription Refill</strong><br>
                    <small>Your Amoxicillin prescription expires in 3 days</small>
                </div>
            </div>
            <button class="btn" onclick="markAllRead()">Mark All as Read</button>
        </div>
    </div>

    <script src="/js/theme.js"></script>
    <script>
        let appointments = [];
        let currentDate = new Date();
        let isCalendarView = true;
        
        loadAppointments();
        loadProfilePicture();
        generateCalendar();
        loadMedicalRecords();
        
        // Profile Picture Upload
        document.getElementById('profileUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('profilePicture').src = e.target.result;
                    document.getElementById('navProfilePic').src = e.target.result;
                    localStorage.setItem('profilePicture', e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });
        
        function loadProfilePicture() {
            const saved = localStorage.getItem('profilePicture');
            const profile = JSON.parse(localStorage.getItem('currentPatient') || '{}');
            
            if (saved) {
                document.getElementById('profilePicture').src = saved;
                document.getElementById('navProfilePic').src = saved;
            }
            
            if (profile.firstName && profile.lastName) {
                document.getElementById('navProfileName').textContent = `${profile.firstName} ${profile.lastName}`;
            } else if (profile.firstName) {
                document.getElementById('navProfileName').textContent = profile.firstName;
            } else {
                window.location.href = '/login';
            }
        }
        
        // Calendar Functions
        function generateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            let html = '';
            
            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month">${daysInPrevMonth - i}</div>`;
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasAppointment = appointments.some(apt => apt.appointmentDate === dateStr);
                const classes = hasAppointment ? 'calendar-day has-appointment' : 'calendar-day';
                
                html += `<div class="${classes}">
                    ${day}
                    ${hasAppointment ? '<div class="appointment-dot"></div>' : ''}
                </div>`;
            }
            
            // Next month days
            const totalCells = Math.ceil((firstDay + daysInMonth) / 7) * 7;
            const remainingCells = totalCells - (firstDay + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                html += `<div class="calendar-day other-month">${day}</div>`;
            }
            
            document.getElementById('calendarGrid').innerHTML = 
                document.getElementById('calendarGrid').innerHTML.split('</div>').slice(0, 7).join('</div>') + '</div>' + html;
        }
        
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            generateCalendar();
        }
        
        function toggleView() {
            const listView = document.getElementById('appointmentsList');
            const calendarView = document.querySelector('.calendar-container');
            const toggleBtn = document.getElementById('viewToggle');
            
            if (isCalendarView) {
                listView.style.display = 'block';
                calendarView.style.display = 'none';
                toggleBtn.textContent = 'Show Calendar View';
                displayAppointments(appointments);
            } else {
                listView.style.display = 'none';
                calendarView.style.display = 'block';
                toggleBtn.textContent = 'Show List View';
            }
            isCalendarView = !isCalendarView;
        }

        async function loadAppointments() {
            try {
                appointments = await fetch('/api/appointments').then(r => r.json());
                updateSummary(appointments);
                generateCalendar();
                loadAppointmentHistory();
            } catch (error) {
                document.getElementById('appointmentsList').innerHTML = '<p style="color: red;">Failed to load appointments</p>';
            }
        }
        
        // Appointment History Functions
        function loadAppointmentHistory() {
            const history = appointments.map(apt => ({
                ...apt,
                statusColor: apt.status === 'Completed' ? '#28a745' : 
                           apt.status === 'Cancelled' ? '#dc3545' : '#007bff'
            }));
            displayHistory(history);
        }
        
        function filterHistory() {
            const filter = document.getElementById('statusFilter').value;
            const filtered = filter === 'all' ? appointments : 
                           appointments.filter(apt => apt.status === filter);
            displayHistory(filtered);
        }
        
        function displayHistory(history) {
            const container = document.getElementById('appointmentHistory');
            if (history.length === 0) {
                container.innerHTML = '<p>No appointments found</p>';
                return;
            }
            
            container.innerHTML = history.map(apt => `
                <div style="background: #f8f9fa; padding: 1rem; margin: 0.5rem 0; border-radius: 5px; border-left: 4px solid ${apt.statusColor || '#007bff'};">
                    <div style="display: flex; justify-content: between; align-items: center;">
                        <div>
                            <strong>${formatDate(apt.appointmentDate)} at ${formatTime(apt.appointmentTime)}</strong><br>
                            <small>Doctor ID: ${apt.doctorId} | Status: ${apt.status || 'Confirmed'}</small>
                        </div>
                        <span style="background: ${apt.statusColor || '#007bff'}; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">
                            ${apt.status || 'Confirmed'}
                        </span>
                    </div>
                </div>
            `).join('');
        }
        
        // Notification Functions
        function markAllRead() {
            document.getElementById('notificationCount').textContent = '0 new';
            alert('All notifications marked as read!');
        }
        
        // Load Medical Records
        async function loadMedicalRecords() {
            try {
                const profile = JSON.parse(localStorage.getItem('currentPatient') || '{}');
                if (!profile.email) {
                    document.getElementById('recentRecordsList').innerHTML = '<p>Please log in to view records</p>';
                    return;
                }
                const email = profile.email;
                
                const records = await fetch(`/api/medical-records/${email}`).then(r => r.json());
                displayRecentRecords(records);
                updateRecordStats(records);
            } catch (error) {
                document.getElementById('recentRecordsList').innerHTML = '<p style="color: red;">Error loading records</p>';
            }
        }
        
        function displayRecentRecords(records) {
            const container = document.getElementById('recentRecordsList');
            
            if (records.length === 0) {
                container.innerHTML = '<p>No medical records found</p>';
                return;
            }
            
            // Show only the 3 most recent records
            const recentRecords = records.slice(-3).reverse();
            
            container.innerHTML = recentRecords.map(record => `
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin: 0.5rem 0; border-left: 3px solid #007bff;">
                    <strong>${record.diagnosis}</strong><br>
                    <small>Dr. ${record.doctorName} - ${formatDate(record.visitDate)}</small>
                </div>
            `).join('');
        }
        
        function updateRecordStats(records) {
            document.getElementById('totalRecords').textContent = records.length;
            
            if (records.length > 0) {
                const lastRecord = records[records.length - 1];
                document.getElementById('lastVisit').textContent = formatDate(lastRecord.visitDate);
            }
        }
        
        // Doctor Rating Functions (for patient_doctors.html)
        function rateDoctor(doctorId) {
            const rating = prompt('Rate this doctor (1-5 stars):');
            if (rating && rating >= 1 && rating <= 5) {
                alert(`Thank you for rating! You gave ${rating} stars.`);
                // In real app, save to database
            }
        }
        
        function reviewDoctor(doctorId) {
            const review = prompt('Write a review for this doctor:');
            if (review) {
                alert('Thank you for your review! It will help other patients.');
                // In real app, save to database
            }
        }
        
        function logout() {
            localStorage.removeItem('currentPatient');
            localStorage.removeItem('currentPatientEmail');
            localStorage.removeItem('profilePicture');
            window.location.href = '/login';
        }

        function displayAppointments(appointments) {
            const container = document.getElementById('appointmentsList');
            
            if (appointments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìÖ</div>
                        <p>No appointments found</p>
                        <button style="padding: 0.8rem 1.5rem; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 1rem;" onclick="window.location.href='/book_appointment'">
                            Book Your First Appointment
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = appointments.map(appointment => `
                <div class="appointment-card">
                    <div class="appointment-header">
                        <span style="font-weight: bold;">${appointment.patientName}</span>
                        <span class="status-badge status-confirmed">Confirmed</span>
                    </div>
                    <div>
                        <p><strong>Date:</strong> ${formatDate(appointment.appointmentDate)}</p>
                        <p><strong>Time:</strong> ${formatTime(appointment.appointmentTime)}</p>
                        <p><strong>Doctor ID:</strong> ${appointment.doctorId}</p>
                        <p><strong>Contact:</strong> ${appointment.patientPhone}</p>
                    </div>
                </div>
            `).join('');
        }

        function updateSummary(appointments) {
            document.getElementById('totalAppointments').textContent = appointments.length;
            
            if (appointments.length > 0) {
                const nextApt = appointments[0];
                document.getElementById('nextAppointment').textContent = formatDate(nextApt.appointmentDate);
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatTime(timeString) {
            return new Date(`2000-01-01T${timeString}`).toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }
    </script>
</body>
</html>